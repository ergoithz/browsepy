


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>tarfile &#8212; browsepy 0.5.6 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/logo.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.5.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tarfile</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1">#-------------------------------------------------------------------</span>
<span class="c1"># tarfile.py</span>
<span class="c1">#-------------------------------------------------------------------</span>
<span class="c1"># Copyright (C) 2002 Lars Gustaebel &lt;lars@gustaebel.de&gt;</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Permission  is  hereby granted,  free  of charge,  to  any person</span>
<span class="c1"># obtaining a  copy of  this software  and associated documentation</span>
<span class="c1"># files  (the  &quot;Software&quot;),  to   deal  in  the  Software   without</span>
<span class="c1"># restriction,  including  without limitation  the  rights to  use,</span>
<span class="c1"># copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies  of  the  Software,  and to  permit  persons  to  whom the</span>
<span class="c1"># Software  is  furnished  to  do  so,  subject  to  the  following</span>
<span class="c1"># conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright  notice and this  permission notice shall  be</span>
<span class="c1"># included in all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS  IS&quot;, WITHOUT WARRANTY OF ANY  KIND,</span>
<span class="c1"># EXPRESS OR IMPLIED, INCLUDING  BUT NOT LIMITED TO  THE WARRANTIES</span>
<span class="c1"># OF  MERCHANTABILITY,  FITNESS   FOR  A  PARTICULAR   PURPOSE  AND</span>
<span class="c1"># NONINFRINGEMENT.  IN  NO  EVENT SHALL  THE  AUTHORS  OR COPYRIGHT</span>
<span class="c1"># HOLDERS  BE LIABLE  FOR ANY  CLAIM, DAMAGES  OR OTHER  LIABILITY,</span>
<span class="c1"># WHETHER  IN AN  ACTION OF  CONTRACT, TORT  OR OTHERWISE,  ARISING</span>
<span class="c1"># FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="c1"># OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Read from and write to tar format archives.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">version</span>     <span class="o">=</span> <span class="s2">&quot;0.9.0&quot;</span>
<span class="n">__author__</span>  <span class="o">=</span> <span class="s2">&quot;Lars Gust</span><span class="se">\u00e4</span><span class="s2">bel (lars@gustaebel.de)&quot;</span>
<span class="n">__date__</span>    <span class="o">=</span> <span class="s2">&quot;$Date: 2011-02-25 17:42:01 +0200 (Fri, 25 Feb 2011) $&quot;</span>
<span class="n">__cvsid__</span>   <span class="o">=</span> <span class="s2">&quot;$Id: tarfile.py 88586 2011-02-25 15:42:01Z marc-andre.lemburg $&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="s2">&quot;Gustavo Niemeyer, Niels Gust</span><span class="se">\u00e4</span><span class="s2">bel, Richard Townsend.&quot;</span>

<span class="c1">#---------</span>
<span class="c1"># Imports</span>
<span class="c1">#---------</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">bltn_open</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pwd</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pwd</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">grp</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">grp</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># os.symlink on Windows prior to 6.0 raises NotImplementedError</span>
<span class="n">symlink_exception</span> <span class="o">=</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># OSError (winerror=1314) will be raised if the caller does not hold the</span>
    <span class="c1"># SeCreateSymbolicLinkPrivilege privilege</span>
    <span class="n">symlink_exception</span> <span class="o">+=</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,)</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># from tarfile import *</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TarFile&quot;</span><span class="p">,</span> <span class="s2">&quot;TarInfo&quot;</span><span class="p">,</span> <span class="s2">&quot;is_tarfile&quot;</span><span class="p">,</span> <span class="s2">&quot;TarError&quot;</span><span class="p">,</span> <span class="s2">&quot;ReadError&quot;</span><span class="p">,</span>
           <span class="s2">&quot;CompressionError&quot;</span><span class="p">,</span> <span class="s2">&quot;StreamError&quot;</span><span class="p">,</span> <span class="s2">&quot;ExtractError&quot;</span><span class="p">,</span> <span class="s2">&quot;HeaderError&quot;</span><span class="p">,</span>
           <span class="s2">&quot;ENCODING&quot;</span><span class="p">,</span> <span class="s2">&quot;USTAR_FORMAT&quot;</span><span class="p">,</span> <span class="s2">&quot;GNU_FORMAT&quot;</span><span class="p">,</span> <span class="s2">&quot;PAX_FORMAT&quot;</span><span class="p">,</span>
           <span class="s2">&quot;DEFAULT_FORMAT&quot;</span><span class="p">,</span> <span class="s2">&quot;open&quot;</span><span class="p">]</span>

<span class="c1">#---------------------------------------------------------</span>
<span class="c1"># tar constants</span>
<span class="c1">#---------------------------------------------------------</span>
<span class="n">NUL</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span>                     <span class="c1"># the null character</span>
<span class="n">BLOCKSIZE</span> <span class="o">=</span> <span class="mi">512</span>                 <span class="c1"># length of processing blocks</span>
<span class="n">RECORDSIZE</span> <span class="o">=</span> <span class="n">BLOCKSIZE</span> <span class="o">*</span> <span class="mi">20</span>     <span class="c1"># length of records</span>
<span class="n">GNU_MAGIC</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;ustar  </span><span class="se">\0</span><span class="s2">&quot;</span>        <span class="c1"># magic gnu tar string</span>
<span class="n">POSIX_MAGIC</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;ustar</span><span class="se">\x00</span><span class="s2">00&quot;</span>    <span class="c1"># magic posix tar string</span>

<span class="n">LENGTH_NAME</span> <span class="o">=</span> <span class="mi">100</span>               <span class="c1"># maximum length of a filename</span>
<span class="n">LENGTH_LINK</span> <span class="o">=</span> <span class="mi">100</span>               <span class="c1"># maximum length of a linkname</span>
<span class="n">LENGTH_PREFIX</span> <span class="o">=</span> <span class="mi">155</span>             <span class="c1"># maximum length of the prefix field</span>

<span class="n">REGTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;0&quot;</span>                  <span class="c1"># regular file</span>
<span class="n">AREGTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span>                <span class="c1"># regular file</span>
<span class="n">LNKTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;1&quot;</span>                  <span class="c1"># link (inside tarfile)</span>
<span class="n">SYMTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;2&quot;</span>                  <span class="c1"># symbolic link</span>
<span class="n">CHRTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;3&quot;</span>                  <span class="c1"># character special device</span>
<span class="n">BLKTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;4&quot;</span>                  <span class="c1"># block special device</span>
<span class="n">DIRTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;5&quot;</span>                  <span class="c1"># directory</span>
<span class="n">FIFOTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;6&quot;</span>                 <span class="c1"># fifo special device</span>
<span class="n">CONTTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;7&quot;</span>                 <span class="c1"># contiguous file</span>

<span class="n">GNUTYPE_LONGNAME</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;L&quot;</span>         <span class="c1"># GNU tar longname</span>
<span class="n">GNUTYPE_LONGLINK</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;K&quot;</span>         <span class="c1"># GNU tar longlink</span>
<span class="n">GNUTYPE_SPARSE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;S&quot;</span>           <span class="c1"># GNU tar sparse file</span>

<span class="n">XHDTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;x&quot;</span>                  <span class="c1"># POSIX.1-2001 extended header</span>
<span class="n">XGLTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;g&quot;</span>                  <span class="c1"># POSIX.1-2001 global header</span>
<span class="n">SOLARIS_XHDTYPE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;X&quot;</span>          <span class="c1"># Solaris extended header</span>

<span class="n">USTAR_FORMAT</span> <span class="o">=</span> <span class="mi">0</span>                <span class="c1"># POSIX.1-1988 (ustar) format</span>
<span class="n">GNU_FORMAT</span> <span class="o">=</span> <span class="mi">1</span>                  <span class="c1"># GNU tar format</span>
<span class="n">PAX_FORMAT</span> <span class="o">=</span> <span class="mi">2</span>                  <span class="c1"># POSIX.1-2001 (pax) format</span>
<span class="n">DEFAULT_FORMAT</span> <span class="o">=</span> <span class="n">GNU_FORMAT</span>

<span class="c1">#---------------------------------------------------------</span>
<span class="c1"># tarfile constants</span>
<span class="c1">#---------------------------------------------------------</span>
<span class="c1"># File types that tarfile supports:</span>
<span class="n">SUPPORTED_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="n">REGTYPE</span><span class="p">,</span> <span class="n">AREGTYPE</span><span class="p">,</span> <span class="n">LNKTYPE</span><span class="p">,</span>
                   <span class="n">SYMTYPE</span><span class="p">,</span> <span class="n">DIRTYPE</span><span class="p">,</span> <span class="n">FIFOTYPE</span><span class="p">,</span>
                   <span class="n">CONTTYPE</span><span class="p">,</span> <span class="n">CHRTYPE</span><span class="p">,</span> <span class="n">BLKTYPE</span><span class="p">,</span>
                   <span class="n">GNUTYPE_LONGNAME</span><span class="p">,</span> <span class="n">GNUTYPE_LONGLINK</span><span class="p">,</span>
                   <span class="n">GNUTYPE_SPARSE</span><span class="p">)</span>

<span class="c1"># File types that will be treated as a regular file.</span>
<span class="n">REGULAR_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="n">REGTYPE</span><span class="p">,</span> <span class="n">AREGTYPE</span><span class="p">,</span>
                 <span class="n">CONTTYPE</span><span class="p">,</span> <span class="n">GNUTYPE_SPARSE</span><span class="p">)</span>

<span class="c1"># File types that are part of the GNU tar format.</span>
<span class="n">GNU_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="n">GNUTYPE_LONGNAME</span><span class="p">,</span> <span class="n">GNUTYPE_LONGLINK</span><span class="p">,</span>
             <span class="n">GNUTYPE_SPARSE</span><span class="p">)</span>

<span class="c1"># Fields from a pax header that override a TarInfo attribute.</span>
<span class="n">PAX_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;linkpath&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;mtime&quot;</span><span class="p">,</span>
              <span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="s2">&quot;gid&quot;</span><span class="p">,</span> <span class="s2">&quot;uname&quot;</span><span class="p">,</span> <span class="s2">&quot;gname&quot;</span><span class="p">)</span>

<span class="c1"># Fields from a pax header that are affected by hdrcharset.</span>
<span class="n">PAX_NAME_FIELDS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;linkpath&quot;</span><span class="p">,</span> <span class="s2">&quot;uname&quot;</span><span class="p">,</span> <span class="s2">&quot;gname&quot;</span><span class="p">}</span>

<span class="c1"># Fields in a pax header that are numbers, all other fields</span>
<span class="c1"># are treated as strings.</span>
<span class="n">PAX_NUMBER_FIELDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;atime&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;ctime&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;mtime&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;uid&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s2">&quot;gid&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">}</span>

<span class="c1">#---------------------------------------------------------</span>
<span class="c1"># initialization</span>
<span class="c1">#---------------------------------------------------------</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
    <span class="n">ENCODING</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ENCODING</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span>

<span class="c1">#---------------------------------------------------------</span>
<span class="c1"># Some useful functions</span>
<span class="c1">#---------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">stn</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a string to a null-terminated bytes object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">*</span> <span class="n">NUL</span>

<span class="k">def</span> <span class="nf">nts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a null-terminated bytes object to a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">p</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">nti</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a number field to a python number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># There are two possible encodings for a number field, see</span>
    <span class="c1"># itn() below.</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mo">0o200</span><span class="p">,</span> <span class="mo">0o377</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mo">0o377</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">256</span> <span class="o">**</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">nts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidHeaderError</span><span class="p">(</span><span class="s2">&quot;invalid header&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span>

<span class="k">def</span> <span class="nf">itn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">DEFAULT_FORMAT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a python number to a number field.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># POSIX 1003.1-1988 requires numbers to be encoded as a string of</span>
    <span class="c1"># octal digits followed by a null-byte, this allows values up to</span>
    <span class="c1"># (8**(digits-1))-1. GNU tar allows storing numbers greater than</span>
    <span class="c1"># that if necessary. A leading 0o200 or 0o377 byte indicate this</span>
    <span class="c1"># particular encoding, the following digits-1 bytes are a big-endian</span>
    <span class="c1"># base-256 representation. This allows values up to (256**(digits-1))-1.</span>
    <span class="c1"># A 0o200 byte indicates a positive number, a 0o377 byte a negative</span>
    <span class="c1"># number.</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">**</span> <span class="p">(</span><span class="n">digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%0*o</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)),</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">NUL</span>
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="n">GNU_FORMAT</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">256</span> <span class="o">**</span> <span class="p">(</span><span class="n">digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="o">**</span> <span class="p">(</span><span class="n">digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mo">0o200</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mo">0o377</span><span class="p">])</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">**</span> <span class="n">digits</span> <span class="o">+</span> <span class="n">n</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mo">0o377</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;overflow in number field&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">calc_chksums</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the checksum for a member&#39;s header by summing up all</span>
<span class="sd">       characters except for the chksum field which is treated as if</span>
<span class="sd">       it was filled with spaces. According to the GNU tar sources,</span>
<span class="sd">       some tars (Sun and NeXT) calculate chksum with signed char,</span>
<span class="sd">       which will be different if there are chars in the buffer with</span>
<span class="sd">       the high bit set. So we calculate two checksums, unsigned and</span>
<span class="sd">       signed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unsigned_chksum</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s2">&quot;148B8x356B&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
    <span class="n">signed_chksum</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s2">&quot;148b8x356b&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">unsigned_chksum</span><span class="p">,</span> <span class="n">signed_chksum</span>

<span class="k">def</span> <span class="nf">copyfileobj</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy length bytes from fileobj src to fileobj dst.</span>
<span class="sd">       If length is None, copy the entire content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bufsize</span> <span class="o">=</span> <span class="n">bufsize</span> <span class="ow">or</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">blocks</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">bufsize</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="p">(</span><span class="s2">&quot;unexpected end of data&quot;</span><span class="p">)</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">remainder</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="p">(</span><span class="s2">&quot;unexpected end of data&quot;</span><span class="p">)</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">filemode</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deprecated in this location; use stat.filemode.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;deprecated in favor of stat.filemode&quot;</span><span class="p">,</span>
                  <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stat</span><span class="o">.</span><span class="n">filemode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_safe_print</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="s1">&#39;backslashreplace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TarError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base exception.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ExtractError</span><span class="p">(</span><span class="n">TarError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;General exception for extract errors.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ReadError</span><span class="p">(</span><span class="n">TarError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception for unreadable tar archives.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">CompressionError</span><span class="p">(</span><span class="n">TarError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception for unavailable compression methods.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">StreamError</span><span class="p">(</span><span class="n">TarError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception for unsupported operations on stream-like TarFiles.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">HeaderError</span><span class="p">(</span><span class="n">TarError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base exception for header errors.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">EmptyHeaderError</span><span class="p">(</span><span class="n">HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception for empty headers.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">TruncatedHeaderError</span><span class="p">(</span><span class="n">HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception for truncated headers.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">EOFHeaderError</span><span class="p">(</span><span class="n">HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception for end of file headers.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">InvalidHeaderError</span><span class="p">(</span><span class="n">HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception for invalid headers.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="k">class</span> <span class="nc">SubsequentHeaderError</span><span class="p">(</span><span class="n">HeaderError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception for missing and invalid extended headers.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="c1">#---------------------------</span>
<span class="c1"># internal stream interface</span>
<span class="c1">#---------------------------</span>
<span class="k">class</span> <span class="nc">_LowLevelFile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Low-level file object. Supports reading and writing.</span>
<span class="sd">       It is used instead of a regular file object for streaming</span>
<span class="sd">       access.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">,</span>
            <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_TRUNC</span><span class="p">,</span>
        <span class="p">}[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;O_BINARY&quot;</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">|=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_BINARY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mo">0o666</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_Stream</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class that serves as an adapter between TarFile and</span>
<span class="sd">       a stream-like object.  The stream-like object only</span>
<span class="sd">       needs to have a read() or write() method and is accessed</span>
<span class="sd">       blockwise.  Use of gzip or bzip2 compression is possible.</span>
<span class="sd">       A stream-like object could be for example: sys.stdin,</span>
<span class="sd">       sys.stdout, a socket, a tape device etc.</span>

<span class="sd">       _Stream is intended to be used only internally.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">comptype</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a _Stream object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extfileobj</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">_LowLevelFile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extfileobj</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">comptype</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="c1"># Enable transparent compression detection for the</span>
            <span class="c1"># stream interface</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">_StreamProxy</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
            <span class="n">comptype</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">getcomptype</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>     <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comptype</span> <span class="o">=</span> <span class="n">comptype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span>  <span class="o">=</span> <span class="n">fileobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span>  <span class="o">=</span> <span class="n">bufsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span>      <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>      <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span>   <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comptype</span> <span class="o">==</span> <span class="s2">&quot;gz&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">zlib</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CompressionError</span><span class="p">(</span><span class="s2">&quot;zlib module is not available&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zlib</span> <span class="o">=</span> <span class="n">zlib</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crc</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_init_read_gz</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">error</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_init_write_gz</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">comptype</span> <span class="o">==</span> <span class="s2">&quot;bz2&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">bz2</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CompressionError</span><span class="p">(</span><span class="s2">&quot;bz2 module is not available&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbuf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2Decompressor</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="ne">OSError</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2Compressor</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">comptype</span> <span class="o">==</span> <span class="s2">&quot;xz&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">lzma</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CompressionError</span><span class="p">(</span><span class="s2">&quot;lzma module is not available&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dbuf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMADecompressor</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMAError</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMACompressor</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">comptype</span> <span class="o">!=</span> <span class="s2">&quot;tar&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CompressionError</span><span class="p">(</span><span class="s2">&quot;unknown compression type </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">comptype</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extfileobj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;closed&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_write_gz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize for writing with gzip compression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="o">.</span><span class="n">compressobj</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="o">.</span><span class="n">DEFLATED</span><span class="p">,</span>
                                            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="o">.</span><span class="n">DEF_MEM_LEVEL</span><span class="p">,</span>
                                            <span class="mi">0</span><span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\037\213\010\010</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\002\377</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># RFC1952 says we must use ISO-8859-1 for the FNAME field.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;iso-8859-1&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">NUL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write string s to the stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comptype</span> <span class="o">==</span> <span class="s2">&quot;gz&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comptype</span> <span class="o">!=</span> <span class="s2">&quot;tar&quot;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmp</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write string s to the stream if a whole new block</span>
<span class="sd">           is ready to be written.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">s</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the _Stream object. No operation should be</span>
<span class="sd">           done on it afterwards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comptype</span> <span class="o">!=</span> <span class="s2">&quot;tar&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comptype</span> <span class="o">==</span> <span class="s2">&quot;gz&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crc</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0xffffFFFF</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extfileobj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_read_gz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize for reading a gzip compressed fileobj.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbuf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># taken from gzip.GzipFile with some alterations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\037\213</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;not a gzip file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\010</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CompressionError</span><span class="p">(</span><span class="s2">&quot;unsupported compression method&quot;</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">xlen</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">256</span> <span class="o">*</span> <span class="nb">ord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">xlen</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="n">NUL</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="n">NUL</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the stream&#39;s file pointer position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the stream&#39;s file pointer to pos. Negative seeking</span>
<span class="sd">           is forbidden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">blocks</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StreamError</span><span class="p">(</span><span class="s2">&quot;seeking backwards is not allowed&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the next size number of bytes from the stream.</span>
<span class="sd">           If size is not defined, return all bytes of the stream</span>
<span class="sd">           up to EOF.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buf</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return size bytes from the stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comptype</span> <span class="o">==</span> <span class="s2">&quot;tar&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbuf</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmp</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;invalid compressed data&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbuf</span> <span class="o">+=</span> <span class="n">buf</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbuf</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbuf</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">buf</span>

    <span class="k">def</span> <span class="nf">__read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return size bytes from stream. If internal buffer is empty,</span>
<span class="sd">           read another block from the stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">buf</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">buf</span>
<span class="c1"># class _Stream</span>

<span class="k">class</span> <span class="nc">_StreamProxy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Small proxy class that enables transparent compression</span>
<span class="sd">       detection for the Stream interface (mode &#39;r|*&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span> <span class="o">=</span> <span class="n">fileobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCKSIZE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span>

    <span class="k">def</span> <span class="nf">getcomptype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x1f\x8b\x08</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;gz&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;BZh&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;1AY&amp;SY&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;bz2&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x5d\x00\x00\x80</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xfd</span><span class="s2">7zXZ&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s2">&quot;xz&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;tar&quot;</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1"># class StreamProxy</span>

<span class="c1">#------------------------</span>
<span class="c1"># Extraction file object</span>
<span class="c1">#------------------------</span>
<span class="k">class</span> <span class="nc">_FileInFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A thin wrapper around an existing file object that</span>
<span class="sd">       provides a part of its data as an individual file</span>
<span class="sd">       object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">blockinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span> <span class="o">=</span> <span class="n">fileobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">blockinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blockinfo</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">)]</span>

        <span class="c1"># Construct a map with data and zero blocks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lastpos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">realpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">blockinfo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">lastpos</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">False</span><span class="p">,</span> <span class="n">lastpos</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">True</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">realpos</span><span class="p">))</span>
            <span class="n">realpos</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="n">lastpos</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span>
        <span class="k">if</span> <span class="n">lastpos</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">False</span><span class="p">,</span> <span class="n">lastpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">seekable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current file position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seek to a position in the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">whence</span> <span class="o">==</span> <span class="n">io</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">whence</span> <span class="o">==</span> <span class="n">io</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">whence</span> <span class="o">==</span> <span class="n">io</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid argument&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read data from the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">map_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">map_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;unexpected end of data&quot;</span><span class="p">)</span>
                <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">+=</span> <span class="n">NUL</span> <span class="o">*</span> <span class="n">length</span>
            <span class="n">size</span> <span class="o">-=</span> <span class="n">length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">length</span>
        <span class="k">return</span> <span class="n">buf</span>

    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="n">b</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)]</span> <span class="o">=</span> <span class="n">buf</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#class _FileInFile</span>

<span class="k">class</span> <span class="nc">ExFileObject</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">):</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">_FileInFile</span><span class="p">(</span><span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">offset_data</span><span class="p">,</span>
                <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">sparse</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
<span class="c1">#class ExFileObject</span>

<span class="c1">#------------------</span>
<span class="c1"># Exported Classes</span>
<span class="c1">#------------------</span>
<span class="k">class</span> <span class="nc">TarInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Informational class which holds the details about an</span>
<span class="sd">       archive member given by a tar header block.</span>
<span class="sd">       TarInfo objects are returned by TarFile.getmember(),</span>
<span class="sd">       TarFile.getmembers() and TarFile.gettarinfo() and are</span>
<span class="sd">       usually created internally.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="s2">&quot;gid&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;mtime&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;chksum&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;linkname&quot;</span><span class="p">,</span> <span class="s2">&quot;uname&quot;</span><span class="p">,</span> <span class="s2">&quot;gname&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;devmajor&quot;</span><span class="p">,</span> <span class="s2">&quot;devminor&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_data&quot;</span><span class="p">,</span> <span class="s2">&quot;pax_headers&quot;</span><span class="p">,</span> <span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;tarfile&quot;</span><span class="p">,</span> <span class="s2">&quot;_sparse_structs&quot;</span><span class="p">,</span> <span class="s2">&quot;_link_target&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a TarInfo object. name is the optional name</span>
<span class="sd">           of the member.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>        <span class="c1"># member name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mo">0o644</span>       <span class="c1"># file permissions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># user id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gid</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># group id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># file size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1"># modification time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># header checksum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">REGTYPE</span>     <span class="c1"># member type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>      <span class="c1"># link name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>         <span class="c1"># user name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>         <span class="c1"># group name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devmajor</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># device major number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devminor</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># device minor number</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># the tar header starts here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_data</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># the file&#39;s data starts here</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sparse</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># sparse member information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pax_headers</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># pax header information</span>

    <span class="c1"># In pax headers the &quot;name&quot; and &quot;linkname&quot; field are called</span>
    <span class="c1"># &quot;path&quot; and &quot;linkpath&quot;.</span>
    <span class="k">def</span> <span class="nf">_getpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
    <span class="k">def</span> <span class="nf">_setpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getpath</span><span class="p">,</span> <span class="n">_setpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getlinkpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkname</span>
    <span class="k">def</span> <span class="nf">_setlinkpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linkname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkname</span> <span class="o">=</span> <span class="n">linkname</span>
    <span class="n">linkpath</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getlinkpath</span><span class="p">,</span> <span class="n">_setlinkpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2"> at </span><span class="si">%#x</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the TarInfo&#39;s attributes as a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mo">0o7777</span><span class="p">,</span>
            <span class="s2">&quot;uid&quot;</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
            <span class="s2">&quot;gid&quot;</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s2">&quot;mtime&quot;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span>
            <span class="s2">&quot;chksum&quot;</span><span class="p">:</span>   <span class="bp">self</span><span class="o">.</span><span class="n">chksum</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="s2">&quot;linkname&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">linkname</span><span class="p">,</span>
            <span class="s2">&quot;uname&quot;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">uname</span><span class="p">,</span>
            <span class="s2">&quot;gname&quot;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">gname</span><span class="p">,</span>
            <span class="s2">&quot;devmajor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">devmajor</span><span class="p">,</span>
            <span class="s2">&quot;devminor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">devminor</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">DIRTYPE</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>

        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">tobuf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">DEFAULT_FORMAT</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">ENCODING</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;surrogateescape&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a tar header as a string of 512 byte blocks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="n">USTAR_FORMAT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_ustar_header</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="n">GNU_FORMAT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_gnu_header</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="n">PAX_FORMAT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_pax_header</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid format&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_ustar_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the object as a ustar header block.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;magic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">POSIX_MAGIC</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;linkname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">LENGTH_LINK</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;linkname is too long&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">LENGTH_NAME</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_posix_split_name</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_header</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">USTAR_FORMAT</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_gnu_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the object as a GNU header block sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;magic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GNU_MAGIC</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;linkname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">LENGTH_LINK</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_gnu_long_header</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;linkname&quot;</span><span class="p">],</span> <span class="n">GNUTYPE_LONGLINK</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">LENGTH_NAME</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_gnu_long_header</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">GNUTYPE_LONGNAME</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">buf</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_header</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">GNU_FORMAT</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_pax_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">encoding</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the object as a ustar header block. If it cannot be</span>
<span class="sd">           represented this way, prepend a pax extended header sequence</span>
<span class="sd">           with supplement information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;magic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">POSIX_MAGIC</span>
        <span class="n">pax_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pax_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Test string fields for values that exceed the field length or cannot</span>
        <span class="c1"># be represented in ASCII encoding.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">hname</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="n">LENGTH_NAME</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;linkname&quot;</span><span class="p">,</span> <span class="s2">&quot;linkpath&quot;</span><span class="p">,</span> <span class="n">LENGTH_LINK</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;uname&quot;</span><span class="p">,</span> <span class="s2">&quot;uname&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;gname&quot;</span><span class="p">,</span> <span class="s2">&quot;gname&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)):</span>

            <span class="k">if</span> <span class="n">hname</span> <span class="ow">in</span> <span class="n">pax_headers</span><span class="p">:</span>
                <span class="c1"># The pax header has priority.</span>
                <span class="k">continue</span>

            <span class="c1"># Try to encode the string as ASCII.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="n">pax_headers</span><span class="p">[</span><span class="n">hname</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">:</span>
                <span class="n">pax_headers</span><span class="p">[</span><span class="n">hname</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># Test number fields for values that exceed the field limit or values</span>
        <span class="c1"># that like to be stored as float.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">digits</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;gid&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;mtime&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pax_headers</span><span class="p">:</span>
                <span class="c1"># The pax header has priority. Avoid overflow.</span>
                <span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="n">val</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">**</span> <span class="p">(</span><span class="n">digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">pax_headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Create a pax extended header if necessary.</span>
        <span class="k">if</span> <span class="n">pax_headers</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_pax_generic_header</span><span class="p">(</span><span class="n">pax_headers</span><span class="p">,</span> <span class="n">XHDTYPE</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">buf</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_header</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">USTAR_FORMAT</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_pax_global_header</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pax_headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the object as a pax global header block sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_create_pax_generic_header</span><span class="p">(</span><span class="n">pax_headers</span><span class="p">,</span> <span class="n">XGLTYPE</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_posix_split_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split a name longer than 100 chars into a prefix</span>
<span class="sd">           and a name part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">components</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">LENGTH_PREFIX</span> <span class="ow">and</span> \
                    <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">LENGTH_NAME</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;name is too long&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">name</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_header</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a header block. info is a dictionary with file</span>
<span class="sd">           information, format must be one of the *_FORMAT constants.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">stn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="mi">100</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">),</span>
            <span class="n">itn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mo">0o7777</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">format</span><span class="p">),</span>
            <span class="n">itn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">format</span><span class="p">),</span>
            <span class="n">itn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gid&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">format</span><span class="p">),</span>
            <span class="n">itn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">12</span><span class="p">,</span> <span class="nb">format</span><span class="p">),</span>
            <span class="n">itn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mtime&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">12</span><span class="p">,</span> <span class="nb">format</span><span class="p">),</span>
            <span class="sa">b</span><span class="s2">&quot;        &quot;</span><span class="p">,</span> <span class="c1"># checksum field</span>
            <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">REGTYPE</span><span class="p">),</span>
            <span class="n">stn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;linkname&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="mi">100</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">),</span>
            <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;magic&quot;</span><span class="p">,</span> <span class="n">POSIX_MAGIC</span><span class="p">),</span>
            <span class="n">stn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uname&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="mi">32</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">),</span>
            <span class="n">stn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gname&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="mi">32</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">),</span>
            <span class="n">itn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;devmajor&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">format</span><span class="p">),</span>
            <span class="n">itn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;devminor&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">format</span><span class="p">),</span>
            <span class="n">stn</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="mi">155</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="n">BLOCKSIZE</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
        <span class="n">chksum</span> <span class="o">=</span> <span class="n">calc_chksums</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="o">-</span><span class="n">BLOCKSIZE</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="o">-</span><span class="mi">364</span><span class="p">]</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%06o</span><span class="se">\0</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">chksum</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="o">-</span><span class="mi">357</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">buf</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the string payload filled with zero bytes</span>
<span class="sd">           up to the next 512 byte border.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blocks</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">BLOCKSIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="p">(</span><span class="n">BLOCKSIZE</span> <span class="o">-</span> <span class="n">remainder</span><span class="p">)</span> <span class="o">*</span> <span class="n">NUL</span>
        <span class="k">return</span> <span class="n">payload</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_gnu_long_header</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a GNUTYPE_LONGNAME or GNUTYPE_LONGLINK sequence</span>
<span class="sd">           for name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span> <span class="o">+</span> <span class="n">NUL</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;././@LongLink&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;magic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GNU_MAGIC</span>

        <span class="c1"># create extended header + name blocks.</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_create_header</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">USTAR_FORMAT</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span> <span class="o">+</span> \
                <span class="bp">cls</span><span class="o">.</span><span class="n">_create_payload</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_pax_generic_header</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pax_headers</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">encoding</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a POSIX.1-2008 extended or global header sequence</span>
<span class="sd">           that contains a list of keyword, value pairs. The values</span>
<span class="sd">           must be strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if one of the fields contains surrogate characters and thereby</span>
        <span class="c1"># forces hdrcharset=BINARY, see _proc_pax() for more information.</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pax_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="n">records</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
            <span class="c1"># Put the hdrcharset field at the beginning of the header.</span>
            <span class="n">records</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;21 hdrcharset=BINARY</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pax_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
                <span class="c1"># Try to restore the original byte representation of `value&#39;.</span>
                <span class="c1"># Needless to say, that the encoding must match the string.</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="s2">&quot;surrogateescape&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span>   <span class="c1"># &#39; &#39; + &#39;=&#39; + &#39;\n&#39;</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">n</span>
            <span class="n">records</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">keyword</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># We use a hardcoded &quot;././@PaxHeader&quot; name like star does</span>
        <span class="c1"># instead of the one that POSIX recommends.</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;././@PaxHeader&quot;</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;magic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">POSIX_MAGIC</span>

        <span class="c1"># Create pax header + record blocks.</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_create_header</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">USTAR_FORMAT</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span> <span class="o">+</span> \
                <span class="bp">cls</span><span class="o">.</span><span class="n">_create_payload</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">frombuf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a TarInfo object from a 512 byte bytes object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EmptyHeaderError</span><span class="p">(</span><span class="s2">&quot;empty header&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BLOCKSIZE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TruncatedHeaderError</span><span class="p">(</span><span class="s2">&quot;truncated header&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">NUL</span><span class="p">)</span> <span class="o">==</span> <span class="n">BLOCKSIZE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EOFHeaderError</span><span class="p">(</span><span class="s2">&quot;end of file header&quot;</span><span class="p">)</span>

        <span class="n">chksum</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">148</span><span class="p">:</span><span class="mi">156</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">chksum</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc_chksums</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidHeaderError</span><span class="p">(</span><span class="s2">&quot;bad checksum&quot;</span><span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">nts</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">108</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">108</span><span class="p">:</span><span class="mi">116</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">gid</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">116</span><span class="p">:</span><span class="mi">124</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">124</span><span class="p">:</span><span class="mi">136</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">136</span><span class="p">:</span><span class="mi">148</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">chksum</span> <span class="o">=</span> <span class="n">chksum</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">156</span><span class="p">:</span><span class="mi">157</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">linkname</span> <span class="o">=</span> <span class="n">nts</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">157</span><span class="p">:</span><span class="mi">257</span><span class="p">],</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">uname</span> <span class="o">=</span> <span class="n">nts</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">265</span><span class="p">:</span><span class="mi">297</span><span class="p">],</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">gname</span> <span class="o">=</span> <span class="n">nts</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">297</span><span class="p">:</span><span class="mi">329</span><span class="p">],</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">devmajor</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">329</span><span class="p">:</span><span class="mi">337</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">devminor</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">337</span><span class="p">:</span><span class="mi">345</span><span class="p">])</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">nts</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">345</span><span class="p">:</span><span class="mi">500</span><span class="p">],</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

        <span class="c1"># Old V7 tar format represents a directory as a regular</span>
        <span class="c1"># file with a trailing slash.</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">AREGTYPE</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DIRTYPE</span>

        <span class="c1"># The old GNU sparse format occupies some of the unused</span>
        <span class="c1"># space in the buffer for up to 4 sparse structures.</span>
        <span class="c1"># Save the them for later processing in _proc_sparse().</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">GNUTYPE_SPARSE</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">386</span>
            <span class="n">structs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">12</span><span class="p">])</span>
                    <span class="n">numbytes</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">12</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">24</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">structs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">offset</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">))</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">24</span>
            <span class="n">isextended</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">482</span><span class="p">])</span>
            <span class="n">origsize</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">483</span><span class="p">:</span><span class="mi">495</span><span class="p">])</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_sparse_structs</span> <span class="o">=</span> <span class="p">(</span><span class="n">structs</span><span class="p">,</span> <span class="n">isextended</span><span class="p">,</span> <span class="n">origsize</span><span class="p">)</span>

        <span class="c1"># Remove redundant slashes from directories.</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">isdir</span><span class="p">():</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="c1"># Reconstruct a ustar longname.</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GNU_TYPES</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromtarfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the next TarInfo object from TarFile object</span>
<span class="sd">           tarfile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCKSIZE</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">frombuf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="n">BLOCKSIZE</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_proc_member</span><span class="p">(</span><span class="n">tarfile</span><span class="p">)</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="c1"># The following are methods that are called depending on the type of a</span>
    <span class="c1"># member. The entry point is _proc_member() which can be overridden in a</span>
    <span class="c1"># subclass to add custom _proc_*() methods. A _proc_*() method MUST</span>
    <span class="c1"># implement the following</span>
    <span class="c1"># operations:</span>
    <span class="c1"># 1. Set self.offset_data to the position where the data blocks begin,</span>
    <span class="c1">#    if there is data that follows.</span>
    <span class="c1"># 2. Set tarfile.offset to the position where the next member&#39;s header will</span>
    <span class="c1">#    begin.</span>
    <span class="c1"># 3. Return self or another valid TarInfo object.</span>
    <span class="k">def</span> <span class="nf">_proc_member</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Choose the right processing method depending on</span>
<span class="sd">           the type and call it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">GNUTYPE_LONGNAME</span><span class="p">,</span> <span class="n">GNUTYPE_LONGLINK</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc_gnulong</span><span class="p">(</span><span class="n">tarfile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">GNUTYPE_SPARSE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc_sparse</span><span class="p">(</span><span class="n">tarfile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">XHDTYPE</span><span class="p">,</span> <span class="n">XGLTYPE</span><span class="p">,</span> <span class="n">SOLARIS_XHDTYPE</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc_pax</span><span class="p">(</span><span class="n">tarfile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc_builtin</span><span class="p">(</span><span class="n">tarfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_proc_builtin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a builtin type or an unknown type which</span>
<span class="sd">           will be treated as a regular file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_data</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isreg</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_TYPES</span><span class="p">:</span>
            <span class="c1"># Skip the following data blocks.</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">tarfile</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>

        <span class="c1"># Patch the TarInfo object with saved global</span>
        <span class="c1"># header information.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_pax_info</span><span class="p">(</span><span class="n">tarfile</span><span class="o">.</span><span class="n">pax_headers</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_proc_gnulong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the blocks that hold a GNU longname</span>
<span class="sd">           or longlink member.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="c1"># Fetch the next header and process it.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fromtarfile</span><span class="p">(</span><span class="n">tarfile</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HeaderError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SubsequentHeaderError</span><span class="p">(</span><span class="s2">&quot;missing or bad subsequent header&quot;</span><span class="p">)</span>

        <span class="c1"># Patch the TarInfo object from the next header with</span>
        <span class="c1"># the longname information.</span>
        <span class="nb">next</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">GNUTYPE_LONGNAME</span><span class="p">:</span>
            <span class="nb">next</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">nts</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">GNUTYPE_LONGLINK</span><span class="p">:</span>
            <span class="nb">next</span><span class="o">.</span><span class="n">linkname</span> <span class="o">=</span> <span class="n">nts</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">next</span>

    <span class="k">def</span> <span class="nf">_proc_sparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a GNU sparse header plus extra headers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We already collected some sparse structures in frombuf().</span>
        <span class="n">structs</span><span class="p">,</span> <span class="n">isextended</span><span class="p">,</span> <span class="n">origsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_structs</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_structs</span>

        <span class="c1"># Collect sparse structures from extended header blocks.</span>
        <span class="k">while</span> <span class="n">isextended</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCKSIZE</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">12</span><span class="p">])</span>
                    <span class="n">numbytes</span> <span class="o">=</span> <span class="n">nti</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">12</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">24</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">offset</span> <span class="ow">and</span> <span class="n">numbytes</span><span class="p">:</span>
                    <span class="n">structs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">offset</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">))</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">24</span>
            <span class="n">isextended</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">504</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse</span> <span class="o">=</span> <span class="n">structs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset_data</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">tarfile</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">origsize</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_proc_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process an extended or global header as described in</span>
<span class="sd">           POSIX.1-2008.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read the header information.</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="c1"># A pax header stores supplemental information for either</span>
        <span class="c1"># the following file (extended) or all following files</span>
        <span class="c1"># (global).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">XGLTYPE</span><span class="p">:</span>
            <span class="n">pax_headers</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">pax_headers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pax_headers</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">pax_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Check if the pax header contains a hdrcharset field. This tells us</span>
        <span class="c1"># the encoding of the path, linkpath, uname and gname fields. Normally,</span>
        <span class="c1"># these fields are UTF-8 encoded but since POSIX.1-2008 tar</span>
        <span class="c1"># implementations are allowed to store them as raw binary strings if</span>
        <span class="c1"># the translation to UTF-8 fails.</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">br</span><span class="s2">&quot;\d+ hdrcharset=([^\n]+)\n&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pax_headers</span><span class="p">[</span><span class="s2">&quot;hdrcharset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="c1"># For the time being, we don&#39;t care about anything other than &quot;BINARY&quot;.</span>
        <span class="c1"># The only other value that is currently allowed by the standard is</span>
        <span class="c1"># &quot;ISO-IR 10646 2000 UTF-8&quot; in other words UTF-8.</span>
        <span class="n">hdrcharset</span> <span class="o">=</span> <span class="n">pax_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hdrcharset&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hdrcharset</span> <span class="o">==</span> <span class="s2">&quot;BINARY&quot;</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">encoding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>

        <span class="c1"># Parse pax header information. A record looks like that:</span>
        <span class="c1"># &quot;%d %s=%s\n&quot; % (length, keyword, value). length is the size</span>
        <span class="c1"># of the complete record including the length field itself and</span>
        <span class="c1"># the newline. keyword and value are both UTF-8 encoded strings.</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">br</span><span class="s2">&quot;(\d+) ([^=]+)=&quot;</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">length</span><span class="p">,</span> <span class="n">keyword</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Normally, we could just use &quot;utf-8&quot; as the encoding and &quot;strict&quot;</span>
            <span class="c1"># as the error handler, but we better not take the risk. For</span>
            <span class="c1"># example, GNU tar &lt;= 1.23 is known to store filenames it cannot</span>
            <span class="c1"># translate to UTF-8 as raw strings (unfortunately without a</span>
            <span class="c1"># hdrcharset=BINARY header).</span>
            <span class="c1"># We first try the strict standard encoding, and if that fails we</span>
            <span class="c1"># fall back on the user&#39;s encoding and error handler.</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_pax_field</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
                    <span class="n">tarfile</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">PAX_NAME_FIELDS</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_pax_field</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
                        <span class="n">tarfile</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_pax_field</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
                        <span class="n">tarfile</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>

            <span class="n">pax_headers</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">length</span>

        <span class="c1"># Fetch the next header.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fromtarfile</span><span class="p">(</span><span class="n">tarfile</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HeaderError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SubsequentHeaderError</span><span class="p">(</span><span class="s2">&quot;missing or bad subsequent header&quot;</span><span class="p">)</span>

        <span class="c1"># Process GNU sparse information.</span>
        <span class="k">if</span> <span class="s2">&quot;GNU.sparse.map&quot;</span> <span class="ow">in</span> <span class="n">pax_headers</span><span class="p">:</span>
            <span class="c1"># GNU extended sparse format version 0.1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc_gnusparse_01</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span> <span class="n">pax_headers</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;GNU.sparse.size&quot;</span> <span class="ow">in</span> <span class="n">pax_headers</span><span class="p">:</span>
            <span class="c1"># GNU extended sparse format version 0.0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc_gnusparse_00</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span> <span class="n">pax_headers</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">pax_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GNU.sparse.major&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">pax_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GNU.sparse.minor&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
            <span class="c1"># GNU extended sparse format version 1.0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc_gnusparse_10</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span> <span class="n">pax_headers</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">XHDTYPE</span><span class="p">,</span> <span class="n">SOLARIS_XHDTYPE</span><span class="p">):</span>
            <span class="c1"># Patch the TarInfo object with the extended header info.</span>
            <span class="nb">next</span><span class="o">.</span><span class="n">_apply_pax_info</span><span class="p">(</span><span class="n">pax_headers</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="nb">next</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

            <span class="k">if</span> <span class="s2">&quot;size&quot;</span> <span class="ow">in</span> <span class="n">pax_headers</span><span class="p">:</span>
                <span class="c1"># If the extended header replaces the size field,</span>
                <span class="c1"># we need to recalculate the offset where the next</span>
                <span class="c1"># header starts.</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">offset_data</span>
                <span class="k">if</span> <span class="nb">next</span><span class="o">.</span><span class="n">isreg</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">next</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_TYPES</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">+=</span> <span class="nb">next</span><span class="o">.</span><span class="n">_block</span><span class="p">(</span><span class="nb">next</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">tarfile</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>

        <span class="k">return</span> <span class="nb">next</span>

    <span class="k">def</span> <span class="nf">_proc_gnusparse_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">pax_headers</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a GNU tar extended sparse header, version 0.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">br</span><span class="s2">&quot;\d+ GNU.sparse.offset=(\d+)\n&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
            <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">numbytes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">br</span><span class="s2">&quot;\d+ GNU.sparse.numbytes=(\d+)\n&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
            <span class="n">numbytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
        <span class="nb">next</span><span class="o">.</span><span class="n">sparse</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_proc_gnusparse_01</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">pax_headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a GNU tar extended sparse header, version 0.1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sparse</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pax_headers</span><span class="p">[</span><span class="s2">&quot;GNU.sparse.map&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="nb">next</span><span class="o">.</span><span class="n">sparse</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sparse</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">sparse</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_proc_gnusparse_10</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">pax_headers</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a GNU tar extended sparse header, version 1.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sparse</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCKSIZE</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparse</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fields</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">+=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCKSIZE</span><span class="p">)</span>
            <span class="n">number</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">sparse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">))</span>
        <span class="nb">next</span><span class="o">.</span><span class="n">offset_data</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="nb">next</span><span class="o">.</span><span class="n">sparse</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sparse</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">sparse</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_apply_pax_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax_headers</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace fields with supplemental information from a previous</span>
<span class="sd">           pax extended or global header.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pax_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">&quot;GNU.sparse.name&quot;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">&quot;GNU.sparse.size&quot;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">&quot;GNU.sparse.realsize&quot;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">PAX_FIELDS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">PAX_NUMBER_FIELDS</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">PAX_NUMBER_FIELDS</span><span class="p">[</span><span class="n">keyword</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pax_headers</span> <span class="o">=</span> <span class="n">pax_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_decode_pax_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">fallback_encoding</span><span class="p">,</span> <span class="n">fallback_errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decode a single field from a pax record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">fallback_encoding</span><span class="p">,</span> <span class="n">fallback_errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Round up a byte count by BLOCKSIZE and return it,</span>
<span class="sd">           e.g. _block(834) =&gt; 1024.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blocks</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">BLOCKSIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remainder</span><span class="p">:</span>
            <span class="n">blocks</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">blocks</span> <span class="o">*</span> <span class="n">BLOCKSIZE</span>

    <span class="k">def</span> <span class="nf">isreg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">REGULAR_TYPES</span>
    <span class="k">def</span> <span class="nf">isfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isreg</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DIRTYPE</span>
    <span class="k">def</span> <span class="nf">issym</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SYMTYPE</span>
    <span class="k">def</span> <span class="nf">islnk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">LNKTYPE</span>
    <span class="k">def</span> <span class="nf">ischr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">CHRTYPE</span>
    <span class="k">def</span> <span class="nf">isblk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BLKTYPE</span>
    <span class="k">def</span> <span class="nf">isfifo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FIFOTYPE</span>
    <span class="k">def</span> <span class="nf">issparse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">isdev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CHRTYPE</span><span class="p">,</span> <span class="n">BLKTYPE</span><span class="p">,</span> <span class="n">FIFOTYPE</span><span class="p">)</span>
<span class="c1"># class TarInfo</span>

<span class="k">class</span> <span class="nc">TarFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The TarFile Class provides an interface to tar archives.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>                   <span class="c1"># May be set from 0 (no msgs) to 3 (all msgs)</span>

    <span class="n">dereference</span> <span class="o">=</span> <span class="kc">False</span>         <span class="c1"># If true, add content of linked file to the</span>
                                <span class="c1"># tar file, else the link.</span>

    <span class="n">ignore_zeros</span> <span class="o">=</span> <span class="kc">False</span>        <span class="c1"># If true, skips empty or invalid blocks and</span>
                                <span class="c1"># continues processing.</span>

    <span class="n">errorlevel</span> <span class="o">=</span> <span class="mi">1</span>              <span class="c1"># If 0, fatal errors only appear in debug</span>
                                <span class="c1"># messages (if debug &gt;= 0). If &gt; 0, errors</span>
                                <span class="c1"># are passed to the caller as exceptions.</span>

    <span class="nb">format</span> <span class="o">=</span> <span class="n">DEFAULT_FORMAT</span>     <span class="c1"># The format to use when creating an archive.</span>

    <span class="n">encoding</span> <span class="o">=</span> <span class="n">ENCODING</span>         <span class="c1"># Encoding for 8-bit character strings.</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="kc">None</span>               <span class="c1"># Error handler for unicode conversion.</span>

    <span class="n">tarinfo</span> <span class="o">=</span> <span class="n">TarInfo</span>           <span class="c1"># The default TarInfo class to use.</span>

    <span class="n">fileobject</span> <span class="o">=</span> <span class="n">ExFileObject</span>   <span class="c1"># The file-object for extractfile().</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">tarinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dereference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_zeros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;surrogateescape&quot;</span><span class="p">,</span> <span class="n">pax_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">errorlevel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copybufsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open an (uncompressed) tar archive `name&#39;. `mode&#39; is either &#39;r&#39; to</span>
<span class="sd">           read from an existing archive, &#39;a&#39; to append data to an existing</span>
<span class="sd">           file or &#39;w&#39; to create a new file overwriting an existing one. `mode&#39;</span>
<span class="sd">           defaults to &#39;r&#39;.</span>
<span class="sd">           If `fileobj&#39; is given, it is used for reading or writing data. If it</span>
<span class="sd">           can be determined, `mode&#39; is overridden by `fileobj&#39;s mode.</span>
<span class="sd">           `fileobj&#39; is not closed, when TarFile is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;r+b&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;xb&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39;, &#39;a&#39;, &#39;w&#39; or &#39;x&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="c1"># Create nonexistent files in append mode.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s2">&quot;wb&quot;</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">bltn_open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extfileobj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extfileobj</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span> <span class="o">=</span> <span class="n">fileobj</span>

        <span class="c1"># Init attributes.</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="nb">format</span>
        <span class="k">if</span> <span class="n">tarinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tarinfo</span> <span class="o">=</span> <span class="n">tarinfo</span>
        <span class="k">if</span> <span class="n">dereference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dereference</span> <span class="o">=</span> <span class="n">dereference</span>
        <span class="k">if</span> <span class="n">ignore_zeros</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_zeros</span> <span class="o">=</span> <span class="n">ignore_zeros</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span>

        <span class="k">if</span> <span class="n">pax_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">PAX_FORMAT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pax_headers</span> <span class="o">=</span> <span class="n">pax_headers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pax_headers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="k">if</span> <span class="n">errorlevel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errorlevel</span> <span class="o">=</span> <span class="n">errorlevel</span>

        <span class="c1"># Init datastructures.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copybufsize</span> <span class="o">=</span> <span class="n">copybufsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">members</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># list of members as TarInfo objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">False</span>    <span class="c1"># flag if all members have been read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                                <span class="c1"># current position in the archive file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inodes</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># dictionary caching the inodes of</span>
                                <span class="c1"># archive members already added</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstmember</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstmember</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
                <span class="c1"># Move to the end of the archive,</span>
                <span class="c1"># before the first empty block.</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">fromtarfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">EOFHeaderError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="n">HeaderError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pax_headers</span><span class="p">:</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">create_pax_global_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pax_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extfileobj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">raise</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="c1"># Below are the classmethods which act as alternate constructors to the</span>
    <span class="c1"># TarFile class. The open() method is the only one that is needed for</span>
    <span class="c1"># public use; it is the &quot;super&quot;-constructor and is able to select an</span>
    <span class="c1"># adequate &quot;sub&quot;-constructor for a particular compression using the mapping</span>
    <span class="c1"># from OPEN_METH.</span>
    <span class="c1">#</span>
    <span class="c1"># This concept allows one to subclass TarFile without losing the comfort of</span>
    <span class="c1"># the super-constructor. A sub-constructor is registered and made available</span>
    <span class="c1"># by adding it to the mapping in OPEN_METH.</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="n">RECORDSIZE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a tar archive for reading, writing or appending. Return</span>
<span class="sd">           an appropriate TarFile class.</span>

<span class="sd">           mode:</span>
<span class="sd">           &#39;r&#39; or &#39;r:*&#39; open for reading with transparent compression</span>
<span class="sd">           &#39;r:&#39;         open for reading exclusively uncompressed</span>
<span class="sd">           &#39;r:gz&#39;       open for reading with gzip compression</span>
<span class="sd">           &#39;r:bz2&#39;      open for reading with bzip2 compression</span>
<span class="sd">           &#39;r:xz&#39;       open for reading with lzma compression</span>
<span class="sd">           &#39;a&#39; or &#39;a:&#39;  open for appending, creating the file if necessary</span>
<span class="sd">           &#39;w&#39; or &#39;w:&#39;  open for writing without compression</span>
<span class="sd">           &#39;w:gz&#39;       open for writing with gzip compression</span>
<span class="sd">           &#39;w:bz2&#39;      open for writing with bzip2 compression</span>
<span class="sd">           &#39;w:xz&#39;       open for writing with lzma compression</span>

<span class="sd">           &#39;x&#39; or &#39;x:&#39;  create a tarfile exclusively without compression, raise</span>
<span class="sd">                        an exception if the file is already created</span>
<span class="sd">           &#39;x:gz&#39;       create a gzip compressed tarfile, raise an exception</span>
<span class="sd">                        if the file is already created</span>
<span class="sd">           &#39;x:bz2&#39;      create a bzip2 compressed tarfile, raise an exception</span>
<span class="sd">                        if the file is already created</span>
<span class="sd">           &#39;x:xz&#39;       create an lzma compressed tarfile, raise an exception</span>
<span class="sd">                        if the file is already created</span>

<span class="sd">           &#39;r|*&#39;        open a stream of tar blocks with transparent compression</span>
<span class="sd">           &#39;r|&#39;         open an uncompressed stream of tar blocks for reading</span>
<span class="sd">           &#39;r|gz&#39;       open a gzip compressed stream of tar blocks</span>
<span class="sd">           &#39;r|bz2&#39;      open a bzip2 compressed stream of tar blocks</span>
<span class="sd">           &#39;r|xz&#39;       open an lzma compressed stream of tar blocks</span>
<span class="sd">           &#39;w|&#39;         open an uncompressed stream for writing</span>
<span class="sd">           &#39;w|gz&#39;       open a gzip compressed stream for writing</span>
<span class="sd">           &#39;w|bz2&#39;      open a bzip2 compressed stream for writing</span>
<span class="sd">           &#39;w|xz&#39;       open an lzma compressed stream for writing</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nothing to open&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;r:*&quot;</span><span class="p">):</span>
            <span class="c1"># Find out which *open() is appropriate for opening the file.</span>
            <span class="k">def</span> <span class="nf">not_compressed</span><span class="p">(</span><span class="n">comptype</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">OPEN_METH</span><span class="p">[</span><span class="n">comptype</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;taropen&#39;</span>
            <span class="k">for</span> <span class="n">comptype</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">OPEN_METH</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">not_compressed</span><span class="p">):</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">OPEN_METH</span><span class="p">[</span><span class="n">comptype</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">ReadError</span><span class="p">,</span> <span class="n">CompressionError</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">saved_pos</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;file could not be opened successfully&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">filemode</span><span class="p">,</span> <span class="n">comptype</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">filemode</span> <span class="o">=</span> <span class="n">filemode</span> <span class="ow">or</span> <span class="s2">&quot;r&quot;</span>
            <span class="n">comptype</span> <span class="o">=</span> <span class="n">comptype</span> <span class="ow">or</span> <span class="s2">&quot;tar&quot;</span>

            <span class="c1"># Select the *open() function according to</span>
            <span class="c1"># given compression.</span>
            <span class="k">if</span> <span class="n">comptype</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">OPEN_METH</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">OPEN_METH</span><span class="p">[</span><span class="n">comptype</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CompressionError</span><span class="p">(</span><span class="s2">&quot;unknown compression type </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">comptype</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filemode</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;|&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">filemode</span><span class="p">,</span> <span class="n">comptype</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">filemode</span> <span class="o">=</span> <span class="n">filemode</span> <span class="ow">or</span> <span class="s2">&quot;r&quot;</span>
            <span class="n">comptype</span> <span class="o">=</span> <span class="n">comptype</span> <span class="ow">or</span> <span class="s2">&quot;tar&quot;</span>

            <span class="k">if</span> <span class="n">filemode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39; or &#39;w&#39;&quot;</span><span class="p">)</span>

            <span class="n">stream</span> <span class="o">=</span> <span class="n">_Stream</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filemode</span><span class="p">,</span> <span class="n">comptype</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filemode</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="n">t</span><span class="o">.</span><span class="n">_extfileobj</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">t</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">taropen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;undiscernible mode&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">taropen</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open uncompressed tar archive name for reading or writing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39;, &#39;a&#39;, &#39;w&#39; or &#39;x&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gzopen</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open gzip compressed tar archive name for reading or writing.</span>
<span class="sd">           Appending is not allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39;, &#39;w&#39; or &#39;x&#39;&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">gzip</span>
            <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CompressionError</span><span class="p">(</span><span class="s2">&quot;gzip module is not available&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span> <span class="o">+</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">compresslevel</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;not a gzip file&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">taropen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;not a gzip file&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="n">t</span><span class="o">.</span><span class="n">_extfileobj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">t</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bz2open</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open bzip2 compressed tar archive name for reading or writing.</span>
<span class="sd">           Appending is not allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39;, &#39;w&#39; or &#39;x&#39;&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">bz2</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CompressionError</span><span class="p">(</span><span class="s2">&quot;bz2 module is not available&quot;</span><span class="p">)</span>

        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">fileobj</span> <span class="ow">or</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
                              <span class="n">compresslevel</span><span class="o">=</span><span class="n">compresslevel</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">taropen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;not a bzip2 file&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="n">t</span><span class="o">.</span><span class="n">_extfileobj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">t</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">xzopen</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open lzma compressed tar archive name for reading or writing.</span>
<span class="sd">           Appending is not allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39;, &#39;w&#39; or &#39;x&#39;&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">lzma</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CompressionError</span><span class="p">(</span><span class="s2">&quot;lzma module is not available&quot;</span><span class="p">)</span>

        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMAFile</span><span class="p">(</span><span class="n">fileobj</span> <span class="ow">or</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">preset</span><span class="o">=</span><span class="n">preset</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">taropen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">lzma</span><span class="o">.</span><span class="n">LZMAError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;not an lzma file&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="n">t</span><span class="o">.</span><span class="n">_extfileobj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">t</span>

    <span class="c1"># All *open() methods are registered here.</span>
    <span class="n">OPEN_METH</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;tar&quot;</span><span class="p">:</span> <span class="s2">&quot;taropen&quot;</span><span class="p">,</span>   <span class="c1"># uncompressed tar</span>
        <span class="s2">&quot;gz&quot;</span><span class="p">:</span>  <span class="s2">&quot;gzopen&quot;</span><span class="p">,</span>    <span class="c1"># gzip compressed tar</span>
        <span class="s2">&quot;bz2&quot;</span><span class="p">:</span> <span class="s2">&quot;bz2open&quot;</span><span class="p">,</span>   <span class="c1"># bzip2 compressed tar</span>
        <span class="s2">&quot;xz&quot;</span><span class="p">:</span>  <span class="s2">&quot;xzopen&quot;</span>     <span class="c1"># lzma compressed tar</span>
    <span class="p">}</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="c1"># The public methods which TarFile provides:</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the TarFile. In write-mode, two finishing zero blocks are</span>
<span class="sd">           appended to the archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">NUL</span> <span class="o">*</span> <span class="p">(</span><span class="n">BLOCKSIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">BLOCKSIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c1"># fill up the end with zero-blocks</span>
                <span class="c1"># (like option -b20 for tar does)</span>
                <span class="n">blocks</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">RECORDSIZE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">NUL</span> <span class="o">*</span> <span class="p">(</span><span class="n">RECORDSIZE</span> <span class="o">-</span> <span class="n">remainder</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extfileobj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getmember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a TarInfo object for member `name&#39;. If `name&#39; can not be</span>
<span class="sd">           found in the archive, KeyError is raised. If a member occurs more</span>
<span class="sd">           than once in the archive, its last occurrence is assumed to be the</span>
<span class="sd">           most up-to-date version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getmember</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tarinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;filename </span><span class="si">%r</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tarinfo</span>

    <span class="k">def</span> <span class="nf">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the members of the archive as a list of TarInfo objects. The</span>
<span class="sd">           list has the same order as the members in the archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span><span class="p">:</span>    <span class="c1"># if we want to obtain a list of</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>        <span class="c1"># all members, we first have to</span>
                                <span class="c1"># scan the whole archive.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">members</span>

    <span class="k">def</span> <span class="nf">getnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the members of the archive as a list of their names. It has</span>
<span class="sd">           the same order as the list returned by getmembers().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tarinfo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">gettarinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a TarInfo object from the result of os.stat or equivalent</span>
<span class="sd">           on an existing file. The file is either named by `name&#39;, or</span>
<span class="sd">           specified as a file object `fileobj&#39; with a file descriptor. If</span>
<span class="sd">           given, `arcname&#39; specifies an alternative name for the file in the</span>
<span class="sd">           archive, otherwise, the name is taken from the &#39;name&#39; attribute of</span>
<span class="sd">           &#39;fileobj&#39;, or the &#39;name&#39; argument. The name should be a text</span>
<span class="sd">           string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="s2">&quot;awx&quot;</span><span class="p">)</span>

        <span class="c1"># When fileobj is given, replace name by</span>
        <span class="c1"># fileobj&#39;s real name.</span>
        <span class="k">if</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Building the name of the member in the archive.</span>
        <span class="c1"># Backward slashes are converted to forward slashes,</span>
        <span class="c1"># Absolute paths are turned to relative paths.</span>
        <span class="k">if</span> <span class="n">arcname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arcname</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">drv</span><span class="p">,</span> <span class="n">arcname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">arcname</span><span class="p">)</span>
        <span class="n">arcname</span> <span class="o">=</span> <span class="n">arcname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">arcname</span> <span class="o">=</span> <span class="n">arcname</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="c1"># Now, fill the TarInfo object with</span>
        <span class="c1"># information specific for the file.</span>
        <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tarinfo</span><span class="p">()</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">tarfile</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># Not needed</span>

        <span class="c1"># Use os.stat or os.lstat, depending on platform</span>
        <span class="c1"># and if symlinks shall be resolved.</span>
        <span class="k">if</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;lstat&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dereference</span><span class="p">:</span>
                <span class="n">statres</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">statres</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">statres</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="n">linkname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">stmd</span> <span class="o">=</span> <span class="n">statres</span><span class="o">.</span><span class="n">st_mode</span>
        <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">stmd</span><span class="p">):</span>
            <span class="n">inode</span> <span class="o">=</span> <span class="p">(</span><span class="n">statres</span><span class="o">.</span><span class="n">st_ino</span><span class="p">,</span> <span class="n">statres</span><span class="o">.</span><span class="n">st_dev</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dereference</span> <span class="ow">and</span> <span class="n">statres</span><span class="o">.</span><span class="n">st_nlink</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> \
                    <span class="n">inode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inodes</span> <span class="ow">and</span> <span class="n">arcname</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inodes</span><span class="p">[</span><span class="n">inode</span><span class="p">]:</span>
                <span class="c1"># Is it a hardlink to an already</span>
                <span class="c1"># archived file?</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">LNKTYPE</span>
                <span class="n">linkname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inodes</span><span class="p">[</span><span class="n">inode</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The inode is added only if its valid.</span>
                <span class="c1"># For win32 it is always 0.</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">REGTYPE</span>
                <span class="k">if</span> <span class="n">inode</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inodes</span><span class="p">[</span><span class="n">inode</span><span class="p">]</span> <span class="o">=</span> <span class="n">arcname</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">stmd</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">DIRTYPE</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">stmd</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">FIFOTYPE</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">stmd</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">SYMTYPE</span>
            <span class="n">linkname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">stmd</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">CHRTYPE</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">stmd</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">BLKTYPE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Fill the TarInfo object with all</span>
        <span class="c1"># information we can get.</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">arcname</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">stmd</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">statres</span><span class="o">.</span><span class="n">st_uid</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">gid</span> <span class="o">=</span> <span class="n">statres</span><span class="o">.</span><span class="n">st_gid</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">REGTYPE</span><span class="p">:</span>
            <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">statres</span><span class="o">.</span><span class="n">st_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="n">statres</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">tarinfo</span><span class="o">.</span><span class="n">linkname</span> <span class="o">=</span> <span class="n">linkname</span>
        <span class="k">if</span> <span class="n">pwd</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tarinfo</span><span class="o">.</span><span class="n">uname</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">grp</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tarinfo</span><span class="o">.</span><span class="n">gname</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">gid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">CHRTYPE</span><span class="p">,</span> <span class="n">BLKTYPE</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;major&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;minor&quot;</span><span class="p">):</span>
                <span class="n">tarinfo</span><span class="o">.</span><span class="n">devmajor</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">major</span><span class="p">(</span><span class="n">statres</span><span class="o">.</span><span class="n">st_rdev</span><span class="p">)</span>
                <span class="n">tarinfo</span><span class="o">.</span><span class="n">devminor</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">minor</span><span class="p">(</span><span class="n">statres</span><span class="o">.</span><span class="n">st_rdev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tarinfo</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print a table of contents to sys.stdout. If `verbose&#39; is False, only</span>
<span class="sd">           the names of the members are printed. If it is True, an `ls -l&#39;-like</span>
<span class="sd">           output is produced. `members&#39; is optional and must be a subset of the</span>
<span class="sd">           list returned by getmembers().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">members</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">members</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">tarinfo</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">_safe_print</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">filemode</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span>
                <span class="n">_safe_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">uname</span> <span class="ow">or</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
                                       <span class="n">tarinfo</span><span class="o">.</span><span class="n">gname</span> <span class="ow">or</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">gid</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">ischr</span><span class="p">()</span> <span class="ow">or</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isblk</span><span class="p">():</span>
                    <span class="n">_safe_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10s</span><span class="s2">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">devmajor</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">devminor</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_safe_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">_safe_print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2"> </span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">&quot;</span> \
                            <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">mtime</span><span class="p">)[:</span><span class="mi">6</span><span class="p">])</span>

            <span class="n">_safe_print</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isdir</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">issym</span><span class="p">():</span>
                    <span class="n">_safe_print</span><span class="p">(</span><span class="s2">&quot;-&gt; &quot;</span> <span class="o">+</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">linkname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">islnk</span><span class="p">():</span>
                    <span class="n">_safe_print</span><span class="p">(</span><span class="s2">&quot;link to &quot;</span> <span class="o">+</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">linkname</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the file `name&#39; to the archive. `name&#39; may be any type of file</span>
<span class="sd">           (directory, fifo, symbolic link, etc.). If given, `arcname&#39;</span>
<span class="sd">           specifies an alternative name for the file in the archive.</span>
<span class="sd">           Directories are added recursively by default. This can be avoided by</span>
<span class="sd">           setting `recursive&#39; to False. `exclude&#39; is a function that should</span>
<span class="sd">           return True for each filename to be excluded. `filter&#39; is a function</span>
<span class="sd">           that expects a TarInfo object argument and returns the changed</span>
<span class="sd">           TarInfo object, if it returns None the TarInfo object will be</span>
<span class="sd">           excluded from the archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="s2">&quot;awx&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">arcname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arcname</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># Exclude pathnames.</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;use the filter argument instead&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exclude</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;tarfile: Excluded </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Skip if somebody tries to archive the archive...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;tarfile: Skipped </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Create a TarInfo object from the file.</span>
        <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettarinfo</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arcname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tarinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tarfile: Unsupported type </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Change or exclude the TarInfo object.</span>
        <span class="k">if</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tarinfo</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tarinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;tarfile: Excluded </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Append the tar header and data to the archive.</span>
        <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isreg</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">bltn_open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isdir</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arcname</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span>
                            <span class="n">recursive</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the TarInfo object `tarinfo&#39; to the archive. If `fileobj&#39; is</span>
<span class="sd">           given, it should be a binary file, and tarinfo.size bytes are read</span>
<span class="sd">           from it and added to the archive. You can create TarInfo objects</span>
<span class="sd">           directly, or by using gettarinfo().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="s2">&quot;awx&quot;</span><span class="p">)</span>

        <span class="n">tarinfo</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">tobuf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">bufsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copybufsize</span>
        <span class="c1"># If there&#39;s data to follow, append it.</span>
        <span class="k">if</span> <span class="n">fileobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">copyfileobj</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="n">bufsize</span><span class="p">)</span>
            <span class="n">blocks</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">BLOCKSIZE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">NUL</span> <span class="o">*</span> <span class="p">(</span><span class="n">BLOCKSIZE</span> <span class="o">-</span> <span class="n">remainder</span><span class="p">))</span>
                <span class="n">blocks</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">blocks</span> <span class="o">*</span> <span class="n">BLOCKSIZE</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extractall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">numeric_owner</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract all members from the archive to the current working</span>
<span class="sd">           directory and set owner, modification time and permissions on</span>
<span class="sd">           directories afterwards. `path&#39; specifies a different directory</span>
<span class="sd">           to extract to. `members&#39; is optional and must be a subset of the</span>
<span class="sd">           list returned by getmembers(). If `numeric_owner` is True, only</span>
<span class="sd">           the numbers for user/group names are used and not the names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">members</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">members</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">tarinfo</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isdir</span><span class="p">():</span>
                <span class="c1"># Extract directories with a safe mode.</span>
                <span class="n">directories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)</span>
                <span class="n">tarinfo</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)</span>
                <span class="n">tarinfo</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mo">0o700</span>
            <span class="c1"># Do not set_attrs directories, as we will do that further down</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">set_attrs</span><span class="o">=</span><span class="ow">not</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isdir</span><span class="p">(),</span>
                         <span class="n">numeric_owner</span><span class="o">=</span><span class="n">numeric_owner</span><span class="p">)</span>

        <span class="c1"># Reverse sort directories.</span>
        <span class="n">directories</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">directories</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="c1"># Set correct owner, mtime and filemode on directories.</span>
        <span class="k">for</span> <span class="n">tarinfo</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
            <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">numeric_owner</span><span class="o">=</span><span class="n">numeric_owner</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ExtractError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorlevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tarfile: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">set_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">numeric_owner</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a member from the archive to the current working directory,</span>
<span class="sd">           using its full name. Its file information is extracted as accurately</span>
<span class="sd">           as possible. `member&#39; may be a filename or a TarInfo object. You can</span>
<span class="sd">           specify a different directory using `path&#39;. File attributes (owner,</span>
<span class="sd">           mtime, mode) are set unless `set_attrs&#39; is False. If `numeric_owner`</span>
<span class="sd">           is True, only the numbers for user/group names are used and not</span>
<span class="sd">           the names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmember</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tarinfo</span> <span class="o">=</span> <span class="n">member</span>

        <span class="c1"># Prepare the link target for makelink().</span>
        <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">islnk</span><span class="p">():</span>
            <span class="n">tarinfo</span><span class="o">.</span><span class="n">_link_target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">linkname</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_member</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                 <span class="n">set_attrs</span><span class="o">=</span><span class="n">set_attrs</span><span class="p">,</span>
                                 <span class="n">numeric_owner</span><span class="o">=</span><span class="n">numeric_owner</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorlevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tarfile: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tarfile: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ExtractError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errorlevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tarfile: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extractfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a member from the archive as a file object. `member&#39; may be</span>
<span class="sd">           a filename or a TarInfo object. If `member&#39; is a regular file or a</span>
<span class="sd">           link, an io.BufferedReader object is returned. Otherwise, None is</span>
<span class="sd">           returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmember</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tarinfo</span> <span class="o">=</span> <span class="n">member</span>

        <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isreg</span><span class="p">()</span> <span class="ow">or</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_TYPES</span><span class="p">:</span>
            <span class="c1"># Members with unknown types are treated as regular files.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">islnk</span><span class="p">()</span> <span class="ow">or</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">issym</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">_Stream</span><span class="p">):</span>
                <span class="c1"># A small but ugly workaround for the case that someone tries</span>
                <span class="c1"># to extract a (sym)link as a file-object from a non-seekable</span>
                <span class="c1"># stream of tar blocks.</span>
                <span class="k">raise</span> <span class="n">StreamError</span><span class="p">(</span><span class="s2">&quot;cannot extract (sym)link as file object&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># A (sym)link&#39;s file object is its target&#39;s file object.</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_link_target</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If there&#39;s no data associated with the member (directory, chrdev,</span>
            <span class="c1"># blkdev, etc.), return None instead of a file object.</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_extract_member</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">,</span> <span class="n">set_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">numeric_owner</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the TarInfo object tarinfo to a physical</span>
<span class="sd">           file called targetpath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Fetch the TarInfo object for the given name</span>
        <span class="c1"># and build the destination pathname, replacing</span>
        <span class="c1"># forward slashes to platform specific separators.</span>
        <span class="n">targetpath</span> <span class="o">=</span> <span class="n">targetpath</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">targetpath</span> <span class="o">=</span> <span class="n">targetpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="c1"># Create all upper directories.</span>
        <span class="n">upperdirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">targetpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upperdirs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">upperdirs</span><span class="p">):</span>
            <span class="c1"># Create directories that are not part of the archive with</span>
            <span class="c1"># default permissions.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">upperdirs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">islnk</span><span class="p">()</span> <span class="ow">or</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">issym</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">linkname</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isreg</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isdir</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makedir</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isfifo</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makefifo</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">ischr</span><span class="p">()</span> <span class="ow">or</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isblk</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makedev</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">islnk</span><span class="p">()</span> <span class="ow">or</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">issym</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makelink</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_TYPES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makeunknown</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">set_attrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">,</span> <span class="n">numeric_owner</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">issym</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="c1"># Below are the different file methods. They are called via</span>
    <span class="c1"># _extract_member() when extract() is called. They can be replaced in a</span>
    <span class="c1"># subclass to implement other functionality.</span>

    <span class="k">def</span> <span class="nf">makedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a directory called targetpath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use a safe mode for the directory, the real mode is set</span>
            <span class="c1"># later in _extract_member().</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">targetpath</span><span class="p">,</span> <span class="mo">0o700</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">makefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a file called targetpath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span>
        <span class="n">source</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">offset_data</span><span class="p">)</span>
        <span class="n">bufsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copybufsize</span>
        <span class="k">with</span> <span class="n">bltn_open</span><span class="p">(</span><span class="n">targetpath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">sparse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">sparse</span><span class="p">:</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                    <span class="n">copyfileobj</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ReadError</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>
                <span class="n">target</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">target</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">copyfileobj</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ReadError</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">makeunknown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a file from a TarInfo object with an unknown type</span>
<span class="sd">           at targetpath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tarfile: Unknown file type </span><span class="si">%r</span><span class="s2">, &quot;</span> \
                     <span class="s2">&quot;extracted as regular file.&quot;</span> <span class="o">%</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">makefifo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a fifo called targetpath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;mkfifo&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkfifo</span><span class="p">(</span><span class="n">targetpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExtractError</span><span class="p">(</span><span class="s2">&quot;fifo not supported by system&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">makedev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a character or block device called targetpath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;mknod&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;makedev&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ExtractError</span><span class="p">(</span><span class="s2">&quot;special devices not supported by system&quot;</span><span class="p">)</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">mode</span>
        <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">isblk</span><span class="p">():</span>
            <span class="n">mode</span> <span class="o">|=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IFBLK</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">|=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IFCHR</span>

        <span class="n">os</span><span class="o">.</span><span class="n">mknod</span><span class="p">(</span><span class="n">targetpath</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">makedev</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">devmajor</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">devminor</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">makelink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a (symbolic) link called targetpath. If it cannot be created</span>
<span class="sd">          (platform limitation), we try to make a copy of the referenced file</span>
<span class="sd">          instead of a link.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># For systems that support symbolic and hard links.</span>
            <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">issym</span><span class="p">():</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">linkname</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># See extract().</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">_link_target</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">_link_target</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_extract_member</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_link_target</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">),</span>
                                         <span class="n">targetpath</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">symlink_exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extract_member</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_link_target</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">),</span>
                                     <span class="n">targetpath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExtractError</span><span class="p">(</span><span class="s2">&quot;unable to resolve link inside archive&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">chown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">,</span> <span class="n">numeric_owner</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set owner of targetpath according to tarinfo. If numeric_owner</span>
<span class="sd">           is True, use .gid/.uid instead of .gname/.uname. If numeric_owner</span>
<span class="sd">           is False, fall back to .gid/.uid when the search based on name</span>
<span class="sd">           fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;geteuid&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># We have to be root to do so.</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">gid</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">uid</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">numeric_owner</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">grp</span><span class="p">:</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">gname</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pwd</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">uname</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">issym</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;lchown&quot;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">lchown</span><span class="p">(</span><span class="n">targetpath</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">targetpath</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExtractError</span><span class="p">(</span><span class="s2">&quot;could not change owner&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">chmod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set file permissions of targetpath according to tarinfo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;chmod&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">targetpath</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExtractError</span><span class="p">(</span><span class="s2">&quot;could not change mode&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">utime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set modification time of targetpath according to tarinfo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;utime&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">targetpath</span><span class="p">,</span> <span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">mtime</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExtractError</span><span class="p">(</span><span class="s2">&quot;could not change modification time&quot;</span><span class="p">)</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the next member of the archive as a TarInfo object, when</span>
<span class="sd">           TarFile is opened for reading. Return None if there is no more</span>
<span class="sd">           available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstmember</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstmember</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">firstmember</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">m</span>

        <span class="c1"># Advance the file pointer.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">tell</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;unexpected end of data&quot;</span><span class="p">)</span>

        <span class="c1"># Read the next block.</span>
        <span class="n">tarinfo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">fromtarfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">EOFHeaderError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_zeros</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0x</span><span class="si">%X</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">BLOCKSIZE</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="n">InvalidHeaderError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_zeros</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0x</span><span class="si">%X</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">BLOCKSIZE</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">EmptyHeaderError</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="s2">&quot;empty file&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">TruncatedHeaderError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">SubsequentHeaderError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ReadError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">tarinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">tarinfo</span>

    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="c1"># Little helper methods:</span>

    <span class="k">def</span> <span class="nf">_getmember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find an archive member by name from bottom to top.</span>
<span class="sd">           If tarinfo is given, it is used as the starting point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure that all members have been loaded.</span>
        <span class="n">members</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()</span>

        <span class="c1"># Limit the member search list up to tarinfo.</span>
        <span class="k">if</span> <span class="n">tarinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">members</span> <span class="o">=</span> <span class="n">members</span><span class="p">[:</span><span class="n">members</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">members</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">member_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">member_name</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="n">name</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">member_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">member</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read through the entire archive file and look for readable</span>
<span class="sd">           members.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tarinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if TarFile is still open, and if the operation&#39;s mode</span>
<span class="sd">           corresponds to TarFile&#39;s mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is closed&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;bad operation for mode </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_link_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tarinfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the target member of a symlink or hardlink member in the</span>
<span class="sd">           archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">issym</span><span class="p">():</span>
            <span class="c1"># Always search the entire archive.</span>
            <span class="n">linkname</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">linkname</span><span class="p">)))</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Search the archive before the link, because a hard link is</span>
            <span class="c1"># just a reference to an already archived file.</span>
            <span class="n">linkname</span> <span class="o">=</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">linkname</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">tarinfo</span>

        <span class="n">member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getmember</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="n">tarinfo</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">member</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;linkname </span><span class="si">%r</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">linkname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">member</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide an iterator object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">members</span>
            <span class="k">return</span>

        <span class="c1"># Yield items using TarFile&#39;s next() method.</span>
        <span class="c1"># When all members have been read, set TarFile as _loaded.</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Fix for SF #1100429: Under rare circumstances it can</span>
        <span class="c1"># happen that getmembers() is called during iteration,</span>
        <span class="c1"># which will have already exhausted the next() method.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstmember</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">yield</span> <span class="n">tarinfo</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">):</span>
                <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span><span class="p">:</span>
                <span class="n">tarinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tarinfo</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">yield</span> <span class="n">tarinfo</span>

    <span class="k">def</span> <span class="nf">_dbg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write debugging output to sys.stderr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># An exception occurred. We must not call close() because</span>
            <span class="c1"># it would try to write end-of-archive blocks and padding.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extfileobj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#--------------------</span>
<span class="c1"># exported functions</span>
<span class="c1">#--------------------</span>
<span class="k">def</span> <span class="nf">is_tarfile</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return True if name points to a tar archive that we</span>
<span class="sd">       are able to handle, else return False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">TarError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="nb">open</span> <span class="o">=</span> <span class="n">TarFile</span><span class="o">.</span><span class="n">open</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;A simple command line interface for tarfile module.&#39;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Verbose output&#39;</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--list&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&lt;tarfile&gt;&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Show listing of a tarfile&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;--extract&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                       <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&lt;tarfile&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;output_dir&gt;&#39;</span><span class="p">),</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Extract tarfile into target dir&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--create&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                       <span class="n">metavar</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&lt;name&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;file&gt;&#39;</span><span class="p">),</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Create tarfile from sources&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--test&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&lt;tarfile&gt;&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Test if a tarfile is valid&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">test</span>
        <span class="k">if</span> <span class="n">is_tarfile</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
                <span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{!r}</span><span class="s1"> is a tar archive.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{!r}</span><span class="s1"> is not a tar archive.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">list</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">list</span>
        <span class="k">if</span> <span class="n">is_tarfile</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">TarFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;r:*&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{!r}</span><span class="s1"> is not a tar archive.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">extract</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">extract</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">extract</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">curdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">extract</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">curdir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">extract</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">format_help</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">is_tarfile</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">TarFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;r:*&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">curdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">curdir</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{!r}</span><span class="s1"> file is extracted.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{!r}</span><span class="s1"> file is extracted &#39;</span>
                           <span class="s1">&#39;into </span><span class="si">{!r}</span><span class="s1"> directory.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">curdir</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{!r}</span><span class="s1"> is not a tar archive.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
        <span class="n">tar_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">create</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">tar_name</span><span class="p">)</span>
        <span class="n">compressions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># gz</span>
            <span class="s1">&#39;.gz&#39;</span><span class="p">:</span> <span class="s1">&#39;gz&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.tgz&#39;</span><span class="p">:</span> <span class="s1">&#39;gz&#39;</span><span class="p">,</span>
            <span class="c1"># xz</span>
            <span class="s1">&#39;.xz&#39;</span><span class="p">:</span> <span class="s1">&#39;xz&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.txz&#39;</span><span class="p">:</span> <span class="s1">&#39;xz&#39;</span><span class="p">,</span>
            <span class="c1"># bz2</span>
            <span class="s1">&#39;.bz2&#39;</span><span class="p">:</span> <span class="s1">&#39;bz2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.tbz&#39;</span><span class="p">:</span> <span class="s1">&#39;bz2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.tbz2&#39;</span><span class="p">:</span> <span class="s1">&#39;bz2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;.tb2&#39;</span><span class="p">:</span> <span class="s1">&#39;bz2&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">tar_mode</span> <span class="o">=</span> <span class="s1">&#39;w:&#39;</span> <span class="o">+</span> <span class="n">compressions</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">compressions</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
        <span class="n">tar_files</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">create</span>

        <span class="k">with</span> <span class="n">TarFile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_name</span><span class="p">,</span> <span class="n">tar_mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">tar_files</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{!r}</span><span class="s1"> file created.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tar_name</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">format_help</span><span class="p">())</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3 class="logo"><a href="../index.html">browsepy</a></h3>
<p>The simple web file browser.</p>
<h3>Useful Links</h3>
<ul>
  <li>
    <a href="http://github.com/ergoithz/browsepy">Browsepy at GitHub</a>
  </li>
  <li>
    <a href="http://pypi.python.org/pypi/browsepy">Browsepy at PyPI</a>
  </li>
  <li>
    <a href="http://github.com/ergoithz/browsepy/issues">Issue Tracker</a>
  </li>
</ul><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Felipe A. Hernandez.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>